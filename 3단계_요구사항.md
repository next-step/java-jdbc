# ğŸš€ 3ë‹¨ê³„ - Transaction ì ìš©í•˜ê¸°

## **ë¯¸ì…˜ ì„¤ëª…**

Userì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ì.

í•´ë‹¹ ê¸°ëŠ¥ì€ UserService í´ë˜ìŠ¤ì˜ changePassword() ë©”ì„œë“œì— êµ¬í˜„ë˜ì–´ìˆë‹¤.

ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ë©´ ëˆ„ê°€, ì–¸ì œ, ì–´ë–¤ ë¹„ë°€ë²ˆí˜¸ë¡œ ë°”ê¿¨ëŠ”ì§€ ì´ë ¥ì„ ë‚¨ê²¨ì•¼ í•œë‹¤.

ì´ë ¥ì´ ìˆì–´ì•¼ ê³ ê°ì„¼í„°ì—ì„œ ê³ ê° ë¬¸ì˜ë¥¼ ëŒ€ì‘í•  ìˆ˜ ìˆë‹¤.

ê³ ê°ì˜ ë³€ê²½ ì´ë ¥ì„ í™•ì¸ í•  ìˆ˜ ìˆë„ë¡ changePassword() ë©”ì„œë“œëŠ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ê³¼ ì´ë ¥ì„ ë‚¨ê¸°ë„ë¡ êµ¬í˜„ë˜ì–´ ìˆë‹¤.

í•˜ì§€ë§Œ changePassword() ë©”ì„œë“œëŠ” ì›ìì„±(Atomic)ì´ ë³´ì¥ë˜ì§€ ì•ŠëŠ”ë‹¤.

ì¤‘ê°„ì— ì˜ˆì™¸ê°€ ë°œìƒí•´ì„œ ì‘ì—…ì„ ì™„ë£Œí•  ìˆ˜ ì—†ë‹¤ë©´ ì‘ì—…ì„ ì›ë˜ ìƒíƒœë¡œ ë˜ëŒë ¤ì•¼ í•œë‹¤.

ì¦‰, ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°”ê¾¸ê³  ì´ë ¥ì„ ë‚¨ê¸°ëŠ” ë„ì¤‘ì— ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ ì›ë˜ ë¹„ë°€ë²ˆí˜¸ë¡œ ëŒë ¤ë†”ì•¼í•œë‹¤.

ì›ìì„±ì„ ë³´ì¥í•˜ê¸° ìœ„í•´ íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ì.

```java
public class UserService {

    private final UserDao userDao;
    private final UserHistoryDao userHistoryDao;

    public UserService(final UserDao userDao, final UserHistoryDao userHistoryDao) {
        this.userDao = userDao;
        this.userHistoryDao = userHistoryDao;
    }

    public User findById(final long id) {
        return userDao.findById(id);
    }

    public void insert(final User user) {
        userDao.insert(user);
    }

    public void changePassword(final long id, final String newPassword, final String createBy) {
        final var user = findById(id);
        user.changePassword(newPassword);
        userDao.update(user);
        userHistoryDao.log(new UserHistory(user, createBy));
    }
}

```

# **ê¸°ëŠ¥ ìš”êµ¬ ì‚¬í•­**

UserServiceTest í´ë˜ìŠ¤ì—ì„œ @Disabledë¥¼ ì‚­ì œí•˜ê³  ë¯¸ì…˜ì„ ì§„í–‰í•œë‹¤.

## **íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •í•˜ê¸°**

[Java Tutorials - Using Transactions](https://docs.oracle.com/javase/tutorial/jdbc/basics/transactions.html)

JDBC APIë¡œ ì–´ë–»ê²Œ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³  ì»¤ë°‹, ë¡¤ë°±ì„ í•  ìˆ˜ ìˆì„ê¹Œ?

Connection ê°ì²´ì˜Â **`setAutoCommit(false)`**Â ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ íŠ¸ëœì­ì…˜ì´ ì‹œì‘ëœë‹¤.

ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ëë‚˜ë©´ ë°˜ë“œì‹œ íŠ¸ëœì­ì…˜ ì»¤ë°‹ ë˜ëŠ” ë¡¤ë°±ì„ ì‹¤í–‰í•œë‹¤.

ì´ì²˜ëŸ¼ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³  ëë‚˜ëŠ” ë¶€ë¶„ì„Â **íŠ¸ëœì­ì…˜ ê²½ê³„**ë¼ê³  í•œë‹¤.

```java
try (final var connection = dataSource.getConnection();) {

    // íŠ¸ëœì­ì…˜ ì‹œì‘
    connection.setAutoCommit(false);

    // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬
    ...

    // íŠ¸ëœì­ì…˜ ì»¤ë°‹
    connection.commit();
} catch (SQLException e) {
    // íŠ¸ëœì­ì…˜ ë¡¤ë°±
    // ë¡œì§ ì²˜ë¦¬ ì¤‘ì— ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ì›ìì„±ì„ ë³´ì¥í•˜ê¸° ìœ„í•´ ë¡¤ë°±í•œë‹¤.
    connection.rollback(); // try-catchë¡œ í•œ ë²ˆ ë” ê°ì‹¸ì•¼ í•˜ì§€ë§Œ ì˜ˆì‹œë‹ˆê¹Œ ìƒëµ
    throw new DataAccessException(e);
}

```

í˜„ì¬ userDaoì™€ userHistoryDaoëŠ” ê°ê° Connection ê°ì²´ë¥¼ ë§Œë“¤ê¸° ë•Œë¬¸ì— ê°œë³„ì ìœ¼ë¡œ íŠ¸ëœì­ì…˜ì´ ìƒì„±ëœë‹¤.

https://techcourse-storage.s3.ap-northeast-2.amazonaws.com/74df1cb8127f4ae187a0ad1876616fae

userDaoì™€ userHistoryDaoë¥¼ í•œ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ìœ¼ë ¤ë©´ ë™ì¼í•œ Connection ê°ì²´ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½í•˜ì.

---
## ìš”êµ¬ì‚¬í•­ ì •ë¦¬

- [ ] userDaoì™€ userHistoryDaoë¥¼ í•œ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ìœ¼ë ¤ë©´ ë™ì¼í•œ Connection ê°ì²´ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½í•œë‹¤
    - [ ] TransactionManager ì¸í„°í˜ì´ìŠ¤ë¥¼ ë§Œë“ ë‹¤
    - [ ] TransactionManager êµ¬í˜„ì²´ì¸ DataSourceTransactionManager ë¥¼ ë§Œë“ ë‹¤